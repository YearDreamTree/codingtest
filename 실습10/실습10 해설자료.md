# 실습10 해설자료
## ✅ 핵심 개념 정리 (SQL)

이번 문제를 해결하기 위해서는 기본적인 SQL 구문에 더해 **서브쿼리(Subquery)** 라는 중요한 개념을 알아야 합니다.

* **`SELECT`, `FROM`, `WHERE`, `ORDER BY`**: 데이터를 조회하고, 테이블을 지정하고, 조건을 걸어 필터링하고, 결과를 정렬하는 SQL의 기본 구성 요소입니다.
* **`AVG(컬럼명)`**: 숫자 컬럼의 평균값을 계산하는 집계 함수입니다.
* **비교 연산자 (`>=`)**: '크거나 같다'를 비교합니다.
* **서브쿼리 (Subquery)**: 다른 SQL 쿼리문 안에 포함된 또 다른 `SELECT` 쿼리문을 의미합니다. 바깥쪽 쿼리를 메인 쿼리(Main Query)라고 부릅니다.
    * **스칼라 서브쿼리 (Scalar Subquery)**: 서브쿼리가 실행되었을 때 **단 하나의 값**(하나의 행, 하나의 열)만을 반환하는 경우를 말합니다. 이렇게 얻어진 단일 값은 메인 쿼리에서 상수처럼 비교 대상 등으로 사용할 수 있습니다. 이 문제의 핵심이 바로 이 스칼라 서브쿼리입니다. `WHERE` 절에서 비교 값으로 자주 활용됩니다.

## ✅ 문제 해결 아이디어

문제의 요구사항은 `movies` 테이블에서 전체 영화의 **평균 리뷰 수(`review_count`) 이상**의 리뷰 수를 가진 영화들의 제목(`title`)과 리뷰 수(`review_count`)를 조회하는 것입니다. 그리고 결과를 제목 순으로 정렬해야 합니다.

여기서 어려운 점은, 각 영화의 리뷰 수를 비교해야 할 대상인 '평균 리뷰 수'가 고정된 값이 아니라, `movies` 테이블 전체 데이터를 바탕으로 **쿼리 실행 시점에 계산되어야** 한다는 것입니다.

이 문제를 해결하기 위한 핵심 아이디어는 **서브쿼리**를 사용하는 것입니다.

1.  **평균 계산 (서브쿼리)**: 먼저, 전체 영화의 평균 `review_count`를 계산하는 서브쿼리를 작성합니다. `SELECT AVG(review_count) FROM movies`는 전체 평균이라는 단 하나의 숫자 값을 반환할 것입니다 (스칼라 서브쿼리).
2.  **조건 비교 (메인 쿼리 `WHERE` 절)**: 메인 쿼리에서는 각 영화의 `review_count`를 가져와서, 위 서브쿼리가 반환한 '평균값'과 `WHERE` 절에서 비교합니다 (`review_count >= (서브쿼리 결과)`).
3.  **결과 선택 및 정렬 (메인 쿼리 `SELECT`, `ORDER BY`)**: `WHERE` 조건를 만족하는 영화들의 `title`과 `review_count`를 `SELECT`하고, `title`을 기준으로 `ORDER BY`하여 최종 결과를 얻습니다.

## ✅ SQL 쿼리 작성 상세

제공된 정답 코드가 위 아이디어를 어떻게 구현하는지 단계별로 살펴봅니다.

1.  **서브쿼리 부분 (평균 계산)**:
    ```sql
    (SELECT AVG(review_count) FROM movies)
    ```
    * 이 부분은 독립적으로 실행되어 `movies` 테이블에 있는 모든 `review_count` 값들의 평균을 계산합니다. 결과는 예를 들어 `2750.5`와 같은 단일 숫자 값이 됩니다. 괄호 `()`로 감싸주는 것이 중요합니다.

2.  **메인 쿼리 부분 (필터링, 선택, 정렬)**:
    ```sql
    SELECT title, review_count
    FROM movies
    WHERE review_count >= (서브쿼리 결과) -- 예: WHERE review_count >= 2750.5
    ORDER BY title;
    ```
    * `FROM movies`: `movies` 테이블의 각 행을 순서대로 살펴봅니다.
    * `WHERE review_count >= (...)`: 각 행의 `review_count` 값이 서브쿼리에서 계산된 평균값보다 크거나 같은지 확인합니다. 이 조건이 참인 행들만 다음 단계로 넘어갑니다.
    * `SELECT title, review_count`: 조건을 통과한 행들에서 `title`과 `review_count` 컬럼 값만 선택합니다.
    * `ORDER BY title`: 선택된 결과들을 `title` 컬럼의 값에 따라 알파벳 오름차순으로 정렬합니다.

## ✅ 전체 SQL 쿼리 구현

위 요소들을 조합하면 다음과 같은 정답 코드가 완성됩니다.

```sql
-- 지시사항을 참고하여 코드를 작성하세요.

SELECT
    title,          -- 최종 출력할 영화 제목
    review_count    -- 최종 출력할 리뷰 수
FROM
    movies          -- movies 테이블에서 조회
WHERE
    review_count >= ( -- 각 영화의 리뷰 수가 ... 보다 크거나 같은 경우만 필터링
        SELECT AVG(review_count) -- 서브쿼리 시작: 전체 영화의 평균 리뷰 수를 계산
        FROM movies
    )               -- 서브쿼리 끝 (결과는 단일 평균값)
ORDER BY
    title;          -- 결과를 영화 제목 오름차순으로 정렬
```

## 🧾 출력 예시 설명

쿼리가 실행되면 다음과 같은 과정을 거칩니다.

1.  데이터베이스는 먼저 서브쿼리 `(SELECT AVG(review_count) FROM movies)`를 실행하여 전체 평균 리뷰 수를 계산합니다. (가령, 이 값이 2700이라고 가정해 봅시다.)
2.  그 다음, 메인 쿼리는 `movies` 테이블을 스캔하면서 각 영화의 `review_count`를 2700과 비교합니다.
    * 'Fight Club' (3000): `3000 >= 2700` (True) -> 선택됨
    * 'Some Movie' (2500): `2500 >= 2700` (False) -> 제외됨
    * 'Schindler's List' (2800): `2800 >= 2700` (True) -> 선택됨
    * ... 이런 식으로 모든 영화를 확인합니다.
3.  선택된 영화들의 `title`과 `review_count`만 결과로 모읍니다.
4.  최종적으로 이 결과들을 `title` 컬럼 기준으로 오름차순 정렬하여 출력 형식에 맞게 보여줍니다.

```
+--------------------------+--------------+
| title                    | review_count |
+--------------------------+--------------+
| Fight Club               | 3000         | <-- 리뷰 수가 평균(가정 2700) 이상인 영화들
| Mad Max: Fury Road       | 3000         |
| Schindler's List         | 2800         |
| The Lion King            | 3700         |
| The Shawshank Redemption | 2500         | <-- 어? 예시에는 2500도 있네요. 아마 실제 평균이 2500 이하였나 봅니다.
+--------------------------+--------------+     ^-- 제목(title) 순으로 정렬됨
```
*(출력 예시의 `The Shawshank Redemption` 리뷰 수가 2500인데 포함된 것을 보면, 실제 데이터의 평균 리뷰 수는 2500 이하임을 알 수 있습니다.)*

## ❗ 자주 하는 실수

* **`WHERE` 절에 집계 함수 직접 사용**: `WHERE review_count >= AVG(review_count)` 와 같이 `WHERE` 절에서 직접 집계 함수를 호출하여 비교하려는 시도는 대부분의 데이터베이스에서 문법 오류입니다. `WHERE` 절은 각 행을 개별적으로 평가하는데, `AVG(review_count)`는 전체 집합에 대한 결과이므로 직접 비교할 수 없습니다. 이럴 때 서브쿼리가 필요합니다.
* **서브쿼리 괄호 누락**: `WHERE review_count >= SELECT AVG(...) ...` 처럼 서브쿼리를 괄호 `()`로 감싸주지 않으면 SQL 문법 오류가 발생합니다. 서브쿼리는 반드시 괄호 안에 작성해야 합니다.
* **비교 연산자 오류**: '평균 이상'은 `>=` 입니다. 만약 `>` (초과)를 사용하면 평균값과 정확히 같은 리뷰 수를 가진 영화는 결과에서 제외됩니다.
* **정렬 조건 오류**: `ORDER BY` 절을 빼먹거나, `title`이 아닌 다른 컬럼으로 정렬하거나, 내림차순(`DESC`)으로 잘못 정렬하면 요구사항과 다른 결과가 나옵니다.

서브쿼리는 SQL에서 매우 유용하고 강력한 기능 중 하나이며, 특히 다른 계산 결과를 바탕으로 조건을 적용해야 할 때 자주 사용됩니다.